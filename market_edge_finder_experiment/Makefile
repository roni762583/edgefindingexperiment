# Market Edge Finder - Docker Management Makefile
# Optimized for caching and local development

.PHONY: help build build-no-cache download-data verify-requirements clean logs status

# Enable BuildKit for advanced caching
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# Default environment
ENV ?= development

# Colors for output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

help: ## Show this help message
	@echo "${BLUE}Market Edge Finder - Docker Management${NC}"
	@echo ""
	@echo "${GREEN}Available targets:${NC}"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  ${YELLOW}%-20s${NC} %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ================================
# Build Operations with Caching
# ================================

build: ## Build all images with caching optimization
	@echo "${GREEN}ðŸ”¨ Building Market Edge Finder with optimized caching...${NC}"
	@mkdir -p ${HOME}/.cache/pip ${HOME}/.cache/torch ${HOME}/.cache/numba
	docker-compose build --parallel
	@echo "${GREEN}âœ… Build completed with caching optimization${NC}"

build-no-cache: ## Build all images without using cache
	@echo "${YELLOW}ðŸ”¨ Building Market Edge Finder without cache...${NC}"
	docker-compose build --no-cache --parallel
	@echo "${GREEN}âœ… Build completed without cache${NC}"

build-data: ## Build only data downloader image
	@echo "${GREEN}ðŸ”¨ Building data downloader with caching...${NC}"
	@mkdir -p ${HOME}/.cache/pip ${HOME}/.cache/torch ${HOME}/.cache/numba
	docker-compose -f docker-compose.data.yml build
	@echo "${GREEN}âœ… Data downloader built${NC}"

# ================================
# Data Download Operations
# ================================

download-data: ## Download OANDA historical data (with mounted local directory)
	@echo "${GREEN}ðŸ“Š Starting OANDA data download...${NC}"
	@if [ ! -f .env ]; then echo "${RED}âŒ .env file not found. Copy .env.example to .env and configure${NC}"; exit 1; fi
	@mkdir -p data logs results
	docker-compose -f docker-compose.data.yml up data-downloader
	@echo "${GREEN}âœ… Data download completed. Check ./data directory${NC}"

download-data-detached: ## Download data in background
	@echo "${GREEN}ðŸ“Š Starting OANDA data download in background...${NC}"
	@mkdir -p data logs results
	docker-compose -f docker-compose.data.yml up -d data-downloader
	@echo "${GREEN}âœ… Data download started in background${NC}"

# ================================
# Verification and Testing
# ================================

verify-requirements: ## Verify all requirements and dependencies
	@echo "${GREEN}ðŸ” Verifying requirements...${NC}"
	docker-compose -f docker-compose.data.yml up requirements-check --profile verification
	@echo "${GREEN}âœ… Requirements verification completed${NC}"

test: ## Run test suite in container
	@echo "${GREEN}ðŸ§ª Running tests...${NC}"
	docker-compose run --rm training-service python -m pytest tests/ -v
	@echo "${GREEN}âœ… Tests completed${NC}"

# ================================
# Development Operations
# ================================

dev: ## Start development environment with Jupyter
	@echo "${GREEN}ðŸ”§ Starting development environment...${NC}"
	docker-compose --profile dev up -d dev-service
	@echo "${GREEN}âœ… Development environment running at http://localhost:8888${NC}"

shell: ## Get shell access to development container
	@echo "${GREEN}ðŸš Opening development shell...${NC}"
	docker-compose run --rm dev-service bash

jupyter: ## Start Jupyter Lab in development container
	@echo "${GREEN}ðŸ““ Starting Jupyter Lab...${NC}"
	docker-compose --profile dev up dev-service

# ================================
# Production Operations
# ================================

up: ## Start all production services
	@echo "${GREEN}ðŸš€ Starting production services...${NC}"
	docker-compose up -d
	@echo "${GREEN}âœ… All services started${NC}"

down: ## Stop all services
	@echo "${YELLOW}â¹ï¸  Stopping all services...${NC}"
	docker-compose down
	@echo "${GREEN}âœ… All services stopped${NC}"

restart: ## Restart all services
	@echo "${YELLOW}ðŸ”„ Restarting services...${NC}"
	docker-compose restart
	@echo "${GREEN}âœ… Services restarted${NC}"

# ================================
# Monitoring and Maintenance
# ================================

status: ## Show status of all services
	@echo "${GREEN}ðŸ“Š Service Status:${NC}"
	docker-compose ps

logs: ## Show logs from all services
	@echo "${GREEN}ðŸ“‹ Service Logs:${NC}"
	docker-compose logs -f

logs-data: ## Show logs from data downloader
	@echo "${GREEN}ðŸ“‹ Data Downloader Logs:${NC}"
	docker-compose -f docker-compose.data.yml logs -f data-downloader

health: ## Check health of all services
	@echo "${GREEN}ðŸ¥ Health Check:${NC}"
	docker-compose exec training-service python scripts/verify_requirements.py

# ================================
# Cleanup Operations
# ================================

clean: ## Clean up unused Docker resources
	@echo "${YELLOW}ðŸ§¹ Cleaning up Docker resources...${NC}"
	docker system prune -f
	docker volume prune -f
	@echo "${GREEN}âœ… Cleanup completed${NC}"

clean-all: ## Clean everything including volumes and images
	@echo "${RED}ðŸ—‘ï¸  WARNING: This will remove all containers, images, and volumes${NC}"
	@echo "${RED}Press Ctrl+C to cancel or Enter to continue...${NC}"
	@read confirm
	docker-compose down -v --rmi all
	docker system prune -af --volumes
	@echo "${GREEN}âœ… Complete cleanup finished${NC}"

clean-cache: ## Clear build cache directories
	@echo "${YELLOW}ðŸ§¹ Clearing build cache...${NC}"
	rm -rf ${HOME}/.cache/pip/wheels
	rm -rf ${HOME}/.cache/torch
	rm -rf ${HOME}/.cache/numba
	@echo "${GREEN}âœ… Cache cleared${NC}"

# ================================
# Quick Start Commands
# ================================

quickstart: build download-data verify-requirements ## Complete setup and data download
	@echo "${GREEN}ðŸŽ‰ Quickstart completed!${NC}"
	@echo "${BLUE}Next steps:${NC}"
	@echo "  1. Configure .env file with your OANDA credentials"
	@echo "  2. Run 'make up' to start training"
	@echo "  3. Run 'make logs' to monitor progress"

setup: ## Initial setup - create directories and copy example files
	@echo "${GREEN}ðŸ”§ Setting up Market Edge Finder...${NC}"
	@mkdir -p data logs results models configs
	@if [ ! -f .env ]; then cp .env.example .env; echo "${YELLOW}ðŸ“ Created .env file - please configure your OANDA credentials${NC}"; fi
	@echo "${GREEN}âœ… Setup completed${NC}"

# ================================
# Information Commands
# ================================

info: ## Show system information
	@echo "${BLUE}Market Edge Finder - System Information${NC}"
	@echo "${GREEN}Docker Version:${NC}"
	@docker --version
	@echo "${GREEN}Docker Compose Version:${NC}"
	@docker-compose --version
	@echo "${GREEN}BuildKit Status:${NC}"
	@echo "DOCKER_BUILDKIT=${DOCKER_BUILDKIT}"
	@echo "${GREEN}Available Disk Space:${NC}"
	@df -h . | tail -1
	@echo "${GREEN}Cache Directory Size:${NC}"
	@du -sh ${HOME}/.cache 2>/dev/null || echo "Cache directory not found"